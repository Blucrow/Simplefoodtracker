@page "/scan"
@inject ISnackbar Snackbar



<div class="d-flex justify-center align-items-center" style="padding-top:2%">
	<MudPaper MaxWidth="600px">
		<MudStack Spacing="2" AlignItems="AlignItems.Center" Justify="Justify.Center">
			<MudButton Variant="Variant.Filled"
			Color="Color.Secondary"
			EndIcon="@Icons.Material.Filled.Scanner"
			Disabled="@_disableButton"
			OnClick="@StartScan">Scan Barcode</MudButton>
			<div id="reader" style="width: 300px;"></div>
			@if (_scanEnabled)
			{
				<div class="mt-2 text-center">
					<div id="reader" class="mx-auto mb-2" style="width:300px">
					</div>
				</div>
				<BlazorBarcodeScanner.ZXing.JS.BarcodeReader StartCameraAutomatically="true"
				VideoWidth="600"
				VideoHeight="300"
				OnBarcodeReceived="@OnBarcodeScanned"
				ShowReset="false"
				ShowVideoDeviceList="false"
				ShowToggleTorch="false"
				ShowResult="false"
				ShowStart="false"
				ShowStop="false"
				LabelVideoDeviceListText=""
				@ref="@_scanner"
				Title="" />
			}
			@if(Product != null)
			{
				<SearchProductResult Product="@Product"></SearchProductResult>
			}
		</MudStack>
	</MudPaper>
</div>

<MudOverlay AutoClose="false" Visible="@_loading" DarkBackground>
	<MudProgressCircular Color="Color.Secondary" Indeterminate="true" />
</MudOverlay>
@code {
	private BarcodeReader _scanner;
	private bool _scanEnabled = false;
	private bool _loading = false;
	private bool _disableButton = false;
	private Product? Product = null;
	private async Task StartScan()
	{
		_disableButton = true;
		_scanEnabled = true;
		StateHasChanged();

	}

	private string LocalBarcodeText = "";

	public async Task OnBarcodeScanned(BarcodeReceivedEventArgs args)
	{
		_loading = true;
		_scanEnabled = false;
		StateHasChanged();
		Product = await Foodservice.GetProductByBarcode(args.BarcodeText);
		_loading = false;
		_disableButton = false;
		if(Product == null)
		{
			_scanner.BarcodeText = "";
			Snackbar.Add("Product not found. Please add it manually.", Severity.Error);
		}
		StateHasChanged();
	}


}
